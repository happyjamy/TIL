# 목차

- [java 멀티스레딩 개요](#java-멀티스레딩-개요)
  - [멀티스레드가 필요한 이유?](#멀티스레드가-필요한-이유)
  - [프로세스와 스레드의 구성](#프로세스와-스레드의-구성)
  - [컨텍스트 스위치](#컨텍스트-스위치)
  - [멀티 스레드 VS 멀티 프로세스 언제 사용할까?](#멀티-스레드-vs-멀티-프로세스-언제-사용할까)

<br>

# java 멀티스레딩 개요

## 멀티스레드가 필요한 이유?

- 응답성
  - 사용자 인터페이스가 있는 애플리케이션의 응답성은 특히 중요
  - 병행성 : 여러개의 스레드로 빠른 멀티태스킹을 구현 → 모든 작업이 동시에 처리 되는 것 처럼 보임
- 성능
  - 싱글스레드를 사용하는 것 보다 같은 시간에 더 많은 작업 가능
  - 여러대 컴퓨터로 대규모 서비스 제공시 기계 수를 줄일 수 있음 → 비용 절감

<br>
<br>

## 프로세스와 스레드의 구성

### 프로세스 구성

![스크린샷 2023-08-22 오후 5 42 16](https://github.com/happyjamy/TIL/assets/78072370/7e19dae5-6de5-4a34-a285-58aa235644d9)

- PID - 운영 체제에서 실행 중인 각 프로세스에 고유하게 부여되는 식별자. 이 ID는 프로세스 관리, 모니터링 및 종료와 같은 작업에 사용
- Files - 애플리케이션이 읽고 쓰기 위해 여는 파일
- code - cpu 에서 실행되는 프로그램 명령어
- heap - 애플리케이션에 필요한 모든 데이터
- Main thread - 메인 스레드라고 불리는 스레드가 적어도 하나 존재

<br>

### 스레드의 구성

<img src="https://github.com/happyjamy/TIL/assets/78072370/7d094d75-0d91-4c86-a475-f71f9948da56" width="300">

<br>

- stack - 메모리 영역으로 지역변수가 저장 되고 기능이 실행되는 영역
- 명령어 포인터 - 스레드가 실행할 다음 명령어의 주소를 가리키는 역할

<br>
<br>

## 컨텍스트 스위치

모든 스레드는 CPU 실행을 두고 경쟁한다. 그러니 운영 체제는 스레드 하나를 실행하고, 멈추고 다른 스레드를 실행하고, 멈추고 이를 반복한다.

> 💡 **컨텍스트 스위치** : 하나의 스레드 실행을 멈추고 다른 스레드를 스케줄링한 다음 스레드를 실행하는 것

![스크린샷 2023-08-22 오후 5 59 22](https://github.com/happyjamy/TIL/assets/78072370/6a844ffc-6f5b-4604-bca2-5c246b09095b)

<br>

### 병행성을 위한 대가

동시에 많은 스레드를 다루는 것은 효율성이 떨어짐.

CPU에서 실행되는 각 스레드는 CPU 내의 레지스터나, 캐시메모리 내의 커널 리소스 같은 것을 일정 부분 차지하게 됨.

다른 스레드로 전환할 때는 기존의 모든 데이터를 저장하고 또 다른 스레드의 리소스를 CPU와 메모리에 복원해야 함.

**Thrashing** 발생. → 운영체제가 우리가 시킨 일보다 스레드 관리 (=컨텍스트 스위치)에 더 많은 시간 할애

<br>
<br>

## 컨텍스트 스위치를 결정하는 방법

- 선착순 스케쥴링
  - 실행시간이 긴 스레드가 먼저 스케쥴을 차지하면 → 기아현상 발생
- 실행 시간이 짧은 순서대로 스케쥴링
  - 연산이 오래 걸리는 작업은 영원히 실행 불가
- 일반적인 운영체제 스케쥴링

  - 에폭에 맞춰 시간을 적당한 크기로 나눔
  - 스레드가 필요한 시간을 하나의 에폭에 할당
  - 이때 모든 스레드가 각 에폭에서 실행되거나 완료 되지는 않는다
    ![스크린샷 2023-08-22 오후 6 29 21](https://github.com/happyjamy/TIL/assets/78072370/2dc13021-dfc8-4f33-bf8f-2fa9c9eed331)

  스레드에 시간 할당을 하는 방법은 OS의 동적 우선 순위에 달림

  > 💡 **동적 우선 순위 = 정적 우선 순위 + 보너스 (보너스는 시간을 뺏을 수도 있음)**

  - 정적 우선순위는 개발자가 미리 설정
  - 보너스는 운영 체제가 각각의 에포크마다 조절

  이렇게 하면 운영 체제는 즉각적인 반응이 필요한 실시간 스레드나 인터랙티브 스레드에게 우선권을 줌. 동시에 기아 현상을 막기 위해 에폭에서 실행시간이 부족했거나 완료 되지 않은 스레드도 챙김.

<br>
<br>

## 멀티 스레드 VS 멀티 프로세스 언제 사용할까?

### 멀티 스레드

- 많은 데이터를 공유하는 다양한 작업을 실행할때 유리
  - 스레드는 프로세스 안 많은 자원을 공유
- 스레드는 생성과 파기가 훨씬 빠르고 전환도 빠름
- 보안과 안정성이 덜 중요할때
  - 스레드 하나때문에 앱 전체가 다운 될 수 있음

### 멀티 프로세스

- 서로 관련 없는 작업을 실행할때
  - 자원 공유 안 함
- 보안과 안정성이 중요할때
  - 프로세스는 각각 독립된 존재. 서로에게 영향 없음.
